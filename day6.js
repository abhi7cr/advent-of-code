const map = `.....#......................................................#...................#.........................................#..#....
.......................#.......#...............................................#.................#...#.......#..............#.....
.........#.................................................................#.....................##...............................
.....#..#.............#.......................#..#....#............#.............................................#................
............#................##............................................#.##..................#.................#.....#...#....
....................................................................#..#.................#.....#................#....#.....#......
.#.........##.................##................#..............................................#..................................
...................#..................#.......#......#......................#..#...................#.........#...............#.#..
.......................#.#.........#...............#....................#........#.............#..................................
......#...........#........................................#........#.........#...............#.#.........#.......................
...#...........................................................#...........#............................#.........................
...........#............................#.#........#...#........#........................................................#........
.........#................................................#...#..#........#............#................#.........................
..#.....................................................................#...............#.........#....#.......#..................
.......................#....#..#............#.........#.............#...................##....................................#...
..................#...................................................................#.....................#...................#.
............................#..........................#.....#...........##.......................................................
........................#.............................#...............#..............................#.........................#..
.....................#..........#...#.....#....#..............#...........................................#...............#.#.....
...................................#.................................#......#..................#..................................
.#.....#.......##......#..................#...............................................#.........................#.........#...
.................#...............#..............................#............................................#......#.............
...#.........#................#...#....................#......................#.#......#.............#............................
.............#..........##....#...#................#.............#.............#............................................#.....
.....#............................................................................................................#...............
........................#..........................##........#........................................#........#..................
..........................#.....##.#.............#.........#..............................#..............................#........
..............#.....................#...............................................#..................................#..........
...#................................................#.........#.....................#..........................................#..
.##..............#..........#......................................................................#.........#........#.........#.
...##.#.....#........#..........................#.............................#..........#.#..#...................................
..................................#...#......#......#................#..#.....................................#...#...............
.........................................................................................#..................#......#..............
.................#....................#..#....#..............................#........##...#.......#...............#..............
...#.................#................#..................................#..................##....##.....#............#...........
..........#...#....................##......................#.....#...........#......#......#.............##....#...#........#.#...
............................#......#.........#..............................................................#........#............
.........................................#.........................................................#...............#.............#
.....#..........#..#........#................................................................................##......#............
.#................#.....................................................................................#.....#...................
..............#........#..................................#..............................##.......................................
........................#.....................#..............................#..................#.............................#.##
#...........................................................#..##........#........................................................
..............#...............#.........#...........^.....................................................#...#.........##..#.....
......................................................#.......................................#..............#...............#....
...#....#..................#....#.......................#.#..........#.......#.................#................................#.
#.........................................................................................................#.......................
..........................#......................................................................#.............#..................
................#...............................................................#........#........................................
..........#............#...............#.#........................................................................................
....#.....#............#.....##.........#......##.................#.......#................#...............................#...#..
................................................................................#...#.......................................#.....
.#........................................#.................................................................#.#...................
.......#....#...................................................................................#...........#..#.............#....
...#...#...............................................................................................................#..........
..#....................................#......#.................#.........................................................#.......
...........................................#......#.........#.##........##..#.........#..........................#....##.#....#...
.........................#...............#............................................................................#...........
................................................#................#..................#..#...........#.......................#.....#
..........................................................#..........#........................................#...................
..................#...................#................##.........#...........................#...................................
............................#.................................................................#...........#.#.....................
................#.......................#.........................................................................#....#..........
#..........#..............#.#............................................................................................#........
..........................................................................................#.......#.........................#....#
...........................................#.......#................................................................#...#.........
..#...................#........................................#..............#.......................#...........................
.......................#..............................#...........................#......#......................#........#........
.....#................................................................................#....#......................................
..#..................................#.........#....#............#....#..............#.............#......#.........#......#....#.
.......##.................................................................................................#.#....#................
............................................#.....#...................#...........#.........#.....................................
...............#.........................................#.............................#.........................#............#...
..............................................##..................................................#........................#......
..................................................................................................#.................#............#
......................#.......................#.........#......................................................................#..
..#...........................#...........................................................................#.....#........#........
..........#....................#...........................##................................................................#....
.........#........#...........................................#........##.........................................................
....#.............................#....................#.................#..........................#........................#....
.......................................#...#....#...............................................#.................................
............#............................................#..............................#..........#......#.......................
.#..............................#...........#........#...............................#.#......#..................................#
#................#..#.............................................................................................................
................................#................#............#....#.#..................##.....................#...............#.#
#....##................#...........#....#..#..........#.....................#..........................#.....................#....
............................................................................................#.....................................
.......................#................................................##..................................#.....................
....#.....#..#................................................................................................##..................
..........................#......#...#...#..........#...#................#.................................................#......
............................#....#.#.......#..........#............................................#..............................
......#...........#......................#..#.....................................................................................
.........................................#...................................................##...............#............#...##.
...................................#.#............................................................................................
......................#........##..................................................#..............................................
...................#......................................................#......#.............................#...........#......
......#................#................................................................................#..................#......
..#.........................#.....#..............#.........#...................#.......................................#..........
..................#..............................................#......#.#.......................................................
...........#.....................................................................#.......................#........................
.......#.........###.....................#........................................................................................
...............#...#..........#........................#....................#......#............#..................#..............
.............#.......#.............#....................................................#.....................................#...
.............................................................................#.#...............................#..#...............
.........##..........#..#.#.................................................................................#................#....
.#..................#.....................................#...................#.#..............#...........................#......
........#.....#...........................#..........................#.............................#...............#..............
#.........#.#.......................................................................................................#.............
..#...................................................................#............#...#.........#................................
..................#......#........#...........#......................#........#..#.......................................#...#..#.
.......................................................#.............#...........#............................#............#......
..............................................#....................................................................#..............
.............#....................#.......................#.............#..........#.........#.............#....#.......#.....#...
...#...................#...............#........#.............#.................#..........#........#................#............
...........#...............#.....................#.................................................#...#.....#.....#..............
....#......................................#......#..............................#...........#.....#..................#...........
#.........#...................#.........#............#............#..............#..........#...........#...#.#..##...............
...........................................................#..................#......#..................#...............#.........
...........#.......................#.........................................................#.......#..............#..........#..
.................................#.....#.....#..............................#..........#..............#............#..............
...............#.......................................................................##.........#...........................#...
....#...............#.........#.#...........#.......#.#..#....#...................................................................
.........#.............................................#.......................................................#..........##......
......................................#...............#.......#..#..#.#...................#....................#.#................
.................#..................................................................#..........................#.....#......#.#...
..#...........#..................#..............#.....#......#.................#..............##.......#...#.......#.......#......
......................................#.....................#..........#............................................##.#..........
#......#................#........................................................#....#....##..................#.................#
............##..............##..........#........##.....................................#..........#..............................
.#.##............#.................#...................#....#...#...............................................#.................
`;
const originalTestMap = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`

const grid = map.split('\n').map(row => row.split(''));
const rows = grid.length;
const columns = grid[0].length;
const directions = [
    // up
    [-1, 0],
    // right
    [0, 1],
    //down
    [1, 0],
    // left
    [0, -1],
];
const len = grid.length;
let uniquePositions = new Set();
// for(let i=0; i < len; ++i) {
//     for(let j=0; j < len; ++j) {
//         if(grid[i][j] === '^') {
//             let queue = [[i,j]];
//             dir = 0;
//             while(queue.length > 0) {
//                 const [x,y] = queue.shift();
//                 uniquePositions.add(`${x},${y}`);
//                 visited.add(`${x},${y}`);
//                 grid[x][y] = 'X';
//                    // reached edges
//                 if (x === 0 || y === 0 || x === len - 1 || y === len - 1) {
//                     console.log('reached exit');
//                     break;
//                 }
//                 // try to go in the same direction
//                 const [dx, dy] = directions[dir];
//                 const newX = x + dx;
//                 const newY = y + dy;
//                 if(grid[newX][newY] === '#') {
//                     dir = (dir + 1) % 4;
//                     const [dx, dy] = directions[dir];
//                     const rightX = x + dx;
//                     const rightY = y + dy;
//                     // move right
//                     queue.push([rightX, rightY]);
//                 } else {
//                     queue.push([newX, newY]);
//                 }
//             }
//         }
//     }
// }
console.time('time');
let start = [];
for (let i = 0; i < rows; ++i) {
    for (let j = 0; j < columns; ++j) {
        if (grid[i][j] === '^') {
            start = [i, j];
            console.log('start', [i,j]);
            break;
        }
    }
}

const visualize = (points, obstruction, loopStart) => {
    console.log('******* OBSTRUCTION AND LOOP START *******', obstruction, loopStart)
    const gridCopy = testMap.split('\n').map(row => row.split(''));
    let prevPoint = null
    let prevDir = 0
    points.forEach(p => {
        let [x, y, dir] = p.split(',');
        x = Number(x);
        y = Number(y);
        dir = Number(dir);
        console.log(x,y,dir);
        if (prevDir !== dir && prevPoint) {
            gridCopy[prevPoint[0]][prevPoint[1]] = '+';
        }
        if (x === start[0] && y === start[1]) {
            gridCopy[x][y] = '^';
        } else if (gridCopy[x][y] !== '+' && (dir === 0 || dir === 2)) {
            gridCopy[x][y] = '|';
        } else if (gridCopy[x][y] !== '+') {
            gridCopy[x][y] = '-';
        }
        prevPoint = [x,y,dir];
        prevDir = dir;
    })
    gridCopy[loopStart[0]][loopStart[1]] = 'L';
    gridCopy[obstruction[0]][obstruction[1]] = 'O';
    console.log(gridCopy.map(row => row.join('')).join('\n'));
}

let loops = new Set();
for (let i = 0; i < rows; ++i) {
    for (let j = 0; j < columns; ++j) {
        if (grid[i][j] === '.') {
            // add obstruction
            grid[i][j] = '#';
            let queue = [[start[0], start[1]]];
            dir = 0;
            const uniquePosAndDir = new Set();
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const [dx, dy] = directions[dir];
   
                let newX = x + dx;
                let newY = y + dy;
                if (newX < 0 || newX >= rows || newY < 0 || newY >= columns) {
                    break;
                }
                while (grid[newX][newY] === '#') {
                    dir = (dir + 1) % 4;
                    const [dx, dy] = directions[dir];
                    newX = x + dx;
                    newY = y + dy;
                }
              
                if (uniquePosAndDir.has(`${x},${y},${dir}`)) {
                    loops.add(`${i}, ${j}`);
                    // visualize([...uniquePosAndDir.values()], [i,j], [x,y]);
                    break;
                }
                uniquePosAndDir.add(`${x},${y},${dir}`);
                queue.push([newX, newY]);
            }
            // remove obstruction
            grid[i][j] = '.'
           
        }
    }
}

console.log(loops.size);


console.timeEnd('time');
